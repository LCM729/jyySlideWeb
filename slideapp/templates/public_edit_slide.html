<!-- templates/public_edit_slide.html -->

<!DOCTYPE html>
<html>
<head>
    <title>{{ slide.title }}</title>
    <style>
        /* 与 edit_slide.html 中的样式一致 */
        body {
            display: flex;
            height: 100vh;
            margin: 0;
        }

        #editor {
            width: 50%;
            height: 100%;
        }

        #preview {
            width: 50%;
            height: 100%;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* 工具栏样式 */
        #toolbar {
            position: fixed;
            top: 20px;
            right: 20px;
        }

        /* 返回按钮样式 */
        .return-button {
            background-color: gray;
            border: none;
            color: #ffffff;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 0;
        }

        .return-button:hover {
            background-color: gray;
        }
    </style>
</head>
<body>
<!-- 工具栏，包含返回公共页面的按钮 -->
<div id="toolbar">
    <button class="return-button" onclick="location.href='{% url 'public_slides' %}'">返回</button>
</div>

<textarea id="editor"></textarea>
<div id="preview">
    <iframe id="preview-iframe"></iframe>
</div>

<!-- 引入必要的 JavaScript 库，例如 jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- 与 WebSocket 进行通信的脚本 -->
<script>
    var slideId = {{ slide.id }};
    var socket = new WebSocket('ws://' + window.location.host + '/ws/public_slide/' + slideId + '/');
    var currentIndices = {h: 0, v: 0, f: undefined};
    var editor = document.getElementById('editor');

    socket.onopen = function (e) {
        console.log('WebSocket 连接已打开');
        // 加载幻灯片内容
        socket.send(JSON.stringify({
            'action': 'load'
        }));
    };

    socket.onmessage = function (e) {
        var data = JSON.parse(e.data);
        var action = data['action'];

        if (action === 'load') {
            // 加载内容到编辑器
            editor.value = data['content'];
            // 初始加载时更新预览
            sendPreview();
        } else if (action === 'preview') {
            var html_content = data['html'];

            var iframe = document.getElementById('preview-iframe');

            // 获取当前幻灯片的索引
            if (iframe.contentWindow && iframe.contentWindow.Reveal && iframe.contentWindow.Reveal.getIndices) {
                currentIndices = iframe.contentWindow.Reveal.getIndices();
            }

            // 更新预览 iframe 的内容
            iframe.contentDocument.open();
            iframe.contentDocument.write(html_content);
            iframe.contentDocument.close();

            // 清除错误消息
            clearErrorMessage();

            // 等待 iframe 加载完成后，恢复幻灯片位置
            iframe.onload = function () {
                function restoreSlide() {
                    if (iframe.contentWindow.Reveal && iframe.contentWindow.Reveal.isReady()) {
                        iframe.contentWindow.Reveal.slide(currentIndices.h, currentIndices.v, currentIndices.f);

                        // 当幻灯片变化时，更新 currentIndices
                        iframe.contentWindow.Reveal.on('slidechanged', function (event) {
                            currentIndices = iframe.contentWindow.Reveal.getIndices();
                        });
                    } else {
                        setTimeout(restoreSlide, 50);
                    }
                }

                restoreSlide();
            };
        } else if (action === 'error') {
            var errorMessage = data['message'];
            displayErrorMessage(errorMessage);
        }
    };

    socket.onclose = function (e) {
        console.log('WebSocket 连接已关闭');
    };

    // 监听编辑器内容的变化，实时预览
    $('#editor').on('input', function () {
        sendPreview();
    });

    function sendPreview() {
        var markdown = $('#editor').val();
        socket.send(JSON.stringify({
            'action': 'preview',
            'markdown': markdown
        }));
    }

    // 显示错误消息
    function displayErrorMessage(message) {
        // 如果不存在错误消息元素，创建一个
        if (!document.getElementById('error-message')) {
            var errorDiv = document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.style.position = 'fixed';
            errorDiv.style.bottom = '20px';
            errorDiv.style.left = '20px';
            errorDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
            errorDiv.style.color = '#fff';
            errorDiv.style.padding = '10px';
            errorDiv.style.borderRadius = '5px';
            errorDiv.style.maxWidth = '300px';
            errorDiv.style.zIndex = '1000';
            errorDiv.style.fontSize = '14px';
            errorDiv.style.lineHeight = '1.5';
            document.body.appendChild(errorDiv);
        }

        var errorDiv = document.getElementById('error-message');
        errorDiv.textContent = '语法错误：' + message;
    }

    // 清除错误消息
    function clearErrorMessage() {
        var errorDiv = document.getElementById('error-message');
        if (errorDiv) {
            errorDiv.parentNode.removeChild(errorDiv);
        }
    }

</script>
</body>
</html>